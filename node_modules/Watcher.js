var util = require('util'),
	EventEmitter = require("events").EventEmitter,
	fs = require('fs'),
	path = require('path');

var watcherUtil = require('./util');
var platform = watcherUtil.platform,
	inotify = require('inotify/'+platform.platform+'/index').inotify,
	INOTIFY_CONST = require('inotify/CONST'),
	misc = watcherUtil.misc,
	logger = watcherUtil.logger,
	readdir = watcherUtil.readdir;

var config,_log,_error,_init,createDelay,_logPath;
var Watcher = function(options){
	this.watchPathList = {};//监控队列
	this.parentPathList = [];//计算出的父级目录
	this.options = options;
	Watcher._init();
}
util.inherits(Watcher,EventEmitter);
/*提供统一的遍历目录并初始化接口*/
Watcher.prototype._readDir = function (dir,isInit,callback) {
	try{
        if(!fs.statSync(dir).isDirectory()){
            return;
        }
    }catch(e){
        return;
    }
    var _this = this;
    var filter = _this.options.filter;
    callback || (callback = function(_pathArr,overInfo){
    	if(_pathArr){
	    	_pathArr.forEach(function(_path){
	    		var tempArr = _path.split('|');
	    		var isFile = tempArr.length == 2;

	    		_path = path.normalize(tempArr[0]);
		        if(filter){
			    	if(!filter(_path)){
			    		_log('filter',_path);
			    		return false;
			    	}
			    }
		        if(isFile){
		            _this._emit(INOTIFY_CONST.EVENT_CHANGE,{
		            	fullname: _path,
		            	filename: path.basename(_path),
		            	isDir: false
		            });
		        }else{
		            if(isInit){
		                _this._addWatch(_path,true,true);
		            }else{
		                _this._addWatch(_path);
		            }                    
		        }
	    	});
    	}else{
    		_init(JSON.stringify(overInfo));
    	}    	
    });
    _init(dir,createDelay);
    readdir(dir,createDelay,_logPath,callback);
}
/*初始化时添加目录监控(配置文件里的watcher),不过滤，遍历子目录*/
Watcher.prototype._initAddWatch = function(watchPath){
    this._addWatch(watchPath,true);
    this._readDir(watchPath,true);
}
/*初始化时添加文件*/
Watcher.prototype.initAddFile = function(file){
    file = path.normalize(file);
    //保证非监控，不触发回调（尤其是监控目录的父级目录）
    if(this.watchFilter.isWatching(file)){
        this._emit(Watcher.MODIFY,file,path.basename(file),Watcher.TYPE_FILE);
    }
}
/*给指定目录添加监控，会自动递归监控子目录*/
Watcher.prototype._addWatch = function(watchPath, isNoReadSub /*是否不用遍历子目录，默认为false,即遍历*/){
	var _this = this;
    watchPath = path.normalize(path.join(watchPath,'.'));
    var filter = _this.options.filter;
    if(filter){
    	if(!filter(watchPath)){
    		_log('filter',watchPath);
    		return false;
    	}
    }
    if(!isNoReadSub && _this.parentPathList.indexOf(path.normalize(path.dirname(watchPath))) > -1||
    	_this.watchPathList[watchPath]){
    	return;
    }
    // for(var i in _this.watchPathList){
    // 	if(watchPath.indexOf(i) == 0){//父级目录已经在监控
    // 		_log('in parent',watchPath);
    // 		return false;
    // 	}
    // }
    if(!fs.existsSync(watchPath)){
    	return;
    }
    console.log(watchPath);
    var inotify_watcher = new inotify(watchPath,function(eventName,data){
    	console.log(eventName,data);
    	var fullname = data.fullname;
    	if(filter){
	    	if(!filter(fullname)){
	    		_log('filter',fullname);
	    		return false;
	    	}
	    }
    	if(INOTIFY_CONST.EVENT_REMOVE == eventName){
    		_this.removeWatch(fullname);
    	}else{
    		if(data.isDir){
    			_this._addWatch(fullname)
    		}
    	}
    	_this._emit(eventName,data);
    });
    _log('addWatch',watchPath);
    _this.watchPathList[watchPath] = inotify_watcher;

    if(!isNoReadSub){
        _this._readDir(watchPath,false);
    }
	return this;
}
Watcher.prototype._emit = function (eventName,data) {
	var filter = this.options.filter;
	var fullname = data.fullname;
    if(filter){
    	if(!filter(fullname)){
    		_log('filter',fullname);
    		return false;
    	}
    }
    
    var dirname = path.normalize(path.dirname(fullname));
    if(dirname == '.' || this.parentPathList.indexOf(dirname) > -1){
    	return;
    }
	_log('emit',eventName,JSON.stringify(data));
	this.emit(eventName,data);
}
/*删除指定路径的监控*/
Watcher.prototype.removeWatch = function(watchPath){
    watchPath = path.normalize(path.join(watchPath, '.'));
    if(!this.watchPathList[watchPath]){
        return;
    }
    var _this = this;
    delete _this.watchPathList[watchPath];
    // var _removeWatch = function(_path){
    //     if(!_path){
    //         return;
    //     }
    //     _path = path.normalize(path.join(_path, '.'));
    //     var _watch = watchPathList[_path];
    //     inotify.removeWatch(_watch);
    //     delete watchPathList[_watch];
    //     delete watchPathList[_path];
    //     _this.watchFilter.removeFilter(_path);
    //     _log('removeWatch',_path);
    // }
    // var subPath = watcherTree.deletePath(watchPath);//添加到观测树中
    // var _dele = function(basePath,node){
    //     for(var i in node){
    //         var _p = path.join(basePath,i);
    //         _removeWatch(_p);
    //         _dele(_p,node[i]);
    //     }
    // }
    // _removeWatch(watchPath);
    // _dele(watchPath,subPath); 
}

/*初始化计算出的父级目录,不过滤，不遍历子目录*/
Watcher.prototype.initAddParentWatch = function(watchPath,subPath){
    var _this = this;
    watchPath = path.normalize(watchPath);
    _this.parentPathList.push(watchPath);
    _this._addWatch(watchPath,true);
    if(subPath){
        //把要监控的子目录优先添加
        if(!misc.isArray(subPath)){
            subPath = [subPath];
        }
        subPath.forEach(function(v){
            _this._initAddWatch(v);
        });
    }
}
/*初始化参数*/
Watcher._init = function(){
    var config = require('../config');
    var newWatcher = config.watcher.slice();
    createDelay = config.create_delay;
    _logPath = config.logPath;
    _log = logger.prefixLogSync(_logPath,'log');
    _error = logger.errorSync(_logPath);
    _init = logger.errorSync(_logPath,'init');
}

module.exports = Watcher;