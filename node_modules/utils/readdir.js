var path = require('path');
var platform = require('./platform');
var misc = require('./misc');
var md5 = misc.md5;
var fsUtil = require('./fs');
var fs = require('fs');
var command = misc.command;

// 得到可执行脚本的目录
var shellDir = (function(){
	var dir = path.join(__dirname,'../../shell/');
	var _platform;
	switch (platform.platform){
		case platform.PLATFORM_WIN32:
			_platform = platform.PLATFORM_WIN32;
			break;
		case platform.PLATFORM_LINUX:
		default :
			_platform = platform.PLATFORM_LINUX;
	}
	return path.join(dir,_platform);
})();

var getReadCommand = (function(){
	if(platform.PLATFORM_WIN32 == platform.platform){
		return function(dirname,time,resultFileName,overFilePath){
			return ['node',path.join(shellDir,'readdir.js'),dirname,time,overFilePath,'>>',resultFileName].join(' ');
		}
	}else{
		return function(dirname,time,resultFileName,overFilePath){
			return ['nohup',path.join(shellDir,'readdir.sh'),dirname,time||'',overFilePath,'>>',resultFileName,'2>&1 &'].join(' ');
		}
	}
})();
var _readdir = function(dirname,time,resultFileName,overFilePath,callback){
	var _command = getReadCommand(dirname,time,resultFileName,overFilePath);
	command(_command,callback);
}
/*windows下会表现为同步*/
var readdir = function(dirname,time,temppath,callback){
	var md5Val = md5(dirname)+new Date().getTime();
	var resultFileName = path.join(temppath,'dir_'+md5Val);
	var overFilePath = path.join(temppath,'over_'+md5Val);
	_readdir(dirname,time,resultFileName,overFilePath,function(){
		if(callback){
			var failNum = 5;
		    var failedNum = 0;
		    var readTT;
			var offset = 0;
	        var totalNum = 0;
	        var inptext = '';
	        var _delay = 1000;
			var _read = function(){
	            clearTimeout(readTT);
	            var stat = fs.statSync(resultFileName);
	            var fileSize = stat.size;
	            if(offset != fileSize){
	                failedNum = 0;//有数据时失败次数重置
	                var readStream = fs.createReadStream(resultFileName,{start:offset,end:fileSize});
	                readStream.setEncoding('utf8');
	                var dataInfo = [];
	                readStream.on('data', function (data) {
	                    offset += data.length;
	                    inptext += data;
	                    var arr = inptext.split('\n');
	                    inptext = arr.pop();//最后一个出栈
	                    totalNum += arr.length;
	                    setTimeout(function(){
	                        callback(arr);
	                    },0)
	                });
	                readStream.on('end', function (close) {
	                    readTT = setTimeout(_read,_delay);//给充足的时间让系统更新文件时间
	                });
	            }else{
	            	if(fs.existsSync(overFilePath)){
	            		var result = null;
	            		var time = fs.readFileSync(overFilePath);
	            		fsUtil.rmdirSync(overFilePath);
			            fsUtil.rmdirSync(resultFileName);
	            		if(inptext){//处理上次处理完后的最后一个
	                        inptext = inptext.split('\n');
	                        totalNum += inptext.length;
	                        result = [inptext];
	                    }
	                    callback(result,{
	                    	dir: dirname,
	                    	totalNum: totalNum,
	                    	time: time+'ms'
	                    });
	            	}else{
	            		readTT = setTimeout(_read,_delay);
	            	}
	            }
	        }
	        _read();
		}
	});	
}
module.exports = readdir;